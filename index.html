<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <title>Linus och Lindrit</title>
      <link rel="stylesheet" href="style.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
      <script src= "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js" type="text/javascript"></script>
    </head>
   <body>  
       <h1 class = "header">Logger</h1>
       <div>
            <div class="wrapper">
                <input type="button" onclick="startConnect()" value="Connect">
                <input type="button" onclick="onSend()" value="Send">
                <input type="button" onclick="startDisconnect()" value="Disconnect">
            <div class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="myRange" oninput="updateValue()">
                <p>Börvärdet: <span id="demo"></span></p>
              </div>
        </div>
        <div class = "container">
            <div class = "textbox inside" id = "messages"></div>
                <div class="inside2"><canvas id="lindritsData" ></canvas></div>  
                <div class="inside2"><canvas id="linusData" ></canvas></div> 
            </div>
        </div>
    <script>    
    
        window.onload = () => {
            document.getElementById("demo").innerHTML = "0";
        }

        let topic ="linus.kasper@abbindustrigymnasium.se/logger";
        var linus_isValue = [];
        var lindrit_isValue = [];    //vi gör listor där värden som kommer in kan läggas in i
        var times = [0];
        var y = [];
        var number = 0;
        
        function startConnect() {   // funktion för att börja anslutningen
            clientID = "clientID_" + parseInt(Math.random() * 100);
            host = "maqiatto.com";
            port = "8883";  
            client = new Paho.MQTT.Client(host, Number(port), clientID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({userName : "linus.kasper@abbindustrigymnasium.se", password : "1234", //bestämmer användarnamn och lösenord så att den kan logga in på maqiatto
                onSuccess: onConnect,
                onFailure: onFail,
                           });
        }
        

        function updateGraphs(){
            
            new Chart(document.getElementById("lindritsData"),  { //första grafen som visar lindrits data
                type: 'line',
                data: {
                    labels: times,
                        datasets: [ { 
                        data: lindrit_isValue,   //datat är den lista som vi definerade sen tidigare
                        pointRadius: 0, 
                        label: "Lindrits Ärvärde",
                        borderColor: "red",   //bestämmer färg på linjerna samt labels
                        fill: false
                    },{ 
                        data: y,
                        pointRadius: 0,  
                        label: "Börvärde",
                        borderColor: "blue",
                        fill: false
                    }
                    ]
                },
                    options: { //options för graafen där vi anpassar den för våra behov
                        animation:{duration: 0},  //tar bort animationerna på grafen
                    scales: {
                            xAxes: [{
                                    display: true,
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time(S)'
                                    }
                                }],
                            yAxes: [{
                                    display: true,
                                    ticks: {
                                        beginAtZero: true,
                                        steps: 1,
                                        stepValue: 5,
                                        max: 100
                                    }
                                }]
                            },
                title: {
                display: true,
                text: 'Lindrits Bil'
                }
                }
                });

                new Chart(document.getElementById("linusData"), { // den andra grafen för linus data
                    type: 'line',
                    data: {
                        labels: times,
                            datasets: [{ 
                        data: linus_isValue,
                        pointRadius: 0, 
                        label: "Linus Ärvärde",
                        borderColor: "green",
                        fill: false
                    },{ 
                        data: y,
                        pointRadius: 0,  
                        label: "Börvärde",
                        borderColor: "blue",
                        fill: false
                    }
                        ]
                    },
                    options: {
                        animation:{duration: 0},
                        scales: {
                                    xAxes: [{
                                            display: true,
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Time(S)'
                                            }
                                        }],
                                    yAxes: [{
                                            display: true,
                                            ticks: {
                                                beginAtZero: true,
                                                steps: 1,
                                                stepValue: 5,
                                                max: 100
                                            }
                                        }]
                                    },
                        title: {
                        display: true,
                        text: 'Linus Bil'
                    }
                    }
                    });
                    
        }

        function onFail() {
            document.getElementById("messages").style.borderColor = "yellow";

        }  // om den misslyckas med anslutningen blir kanterna på den vita rutan gula

        function onConnect() { // funktion för att ansluta till mqtt
            console.log(topic);
            client.subscribe(topic);
            document.getElementById("messages").style.borderColor = "green";
        } // om anslutningen lyckas blir kanterna gröna

        function onSend() { // funktion för att skicka värden till maqiatto från hemsidan när vi klickar send
            let message = document.getElementById("myRange").value;
            console.log(message);
            message= new Paho.MQTT.Message(message);
            message.destinationName=topic;
            client.send(message);
        }

        function updateValue(){ // funktion för när vi uppdaterar meddelandet när slidern justeras
            let message = document.getElementById("myRange").value;
            document.getElementById("demo").innerHTML = message;
        }

        function onConnectionLost(responseObject) { // om anslutningen förloras gör vi kanterna på rutan gula
            document.getElementById("messages").style.borderColor = "yellow";
        }

        function onMessageArrived(message) { // funktion som sorterar värderna när vi får in ett meddelande
            console.log("onMessageArrived: " + message.payloadString);
            var d = new Date();
            var hours = d.getHours();
            var minutes = d.getMinutes();
            if (minutes < 10){
                var time = hours + ":" + "0" + minutes;
            } else {
                var time = hours + ":" + minutes;
            }
            var mes = message.payloadString;
            var values = mes.split(" ");  // vi splittar meddelandet och får en array med värdena som kommit in
            console.log(values)
            number+=1
            let x = document.getElementById("myRange").value
            times.push(number)
            y.push(x)
            if (values[0] == "linus"){ // om det första elementet i listan är linus lägger den in värdena i linus dataset
                linus_isValue.push(parseInt(values[1])); 
            } else if (values[0] == "lindrit"){ // den gör samma sak om första elementet är lindrit
                lindrit_isValue.push(parseInt(values[1]));
            }
            document.getElementById("messages").innerHTML += '<span style="float:left;">' + time + " | " + message.payloadString + '</span><br/>'; //skriver ut meddelandet i loggern
            updateGraphs();
            var objDiv = document.getElementById("messages");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        function startDisconnect() { //funktion för att koppla bort från mqtt
            client.disconnect();
            document.getElementById("messages").style.borderColor = "red"; //den vita rutan får då röda kanter
            document.getElementById('messages').innerHTML = '';
        }
        </script>
</html>