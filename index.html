<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <title>Linus och Lindrit</title>
      <link rel="stylesheet" href="style.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
      <script src= "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js" type="text/javascript"></script>
    </head>
   <body>  
       <h1 class = "header">Logger</h1>
       <div>
            <div class="wrapper">
                <input type="button" onclick="startConnect()" value="Connect">
                <input type="button" onclick="onSend()" value="Send">
                <input type="button" onclick="startDisconnect()" value="Disconnect">
            <div class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="myRange" oninput="updateValue()">
                <p>Börvärdet: <span id="demo"></span></p>
              </div>
        </div>
        <div class = "container">
            <div class = "textbox inside" id = "messages"></div>
                <div class="inside2"><canvas id="lindritsData" ></canvas></div>  
                <div class="inside2"><canvas id="linusData" ></canvas></div> 
            </div>
        </div>
    <script>    
    
        window.onload = () => {
            document.getElementById("demo").innerHTML = "0";
        }

        let topic ="linus.kasper@abbindustrigymnasium.se/logger";
        var linus_isValue = [];
        var lindrit_isValue = [];
        var linus_PWM = [];
        var lindrit_PWM = [];
        var linus_error = [];
        var lindrit_error = [];
        var times = [0];
        var y = [];
        var number = 0;
        
        function startConnect() {
            clientID = "clientID_" + parseInt(Math.random() * 100);
            host = "maqiatto.com";
            port = "8883";
            client = new Paho.MQTT.Client(host, Number(port), clientID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({userName : "linus.kasper@abbindustrigymnasium.se", password : "1234",
                onSuccess: onConnect,
                onFailure: onFail,
                           });
        }
        

        function updateGraphs(){
            
            new Chart(document.getElementById("linusData"),  {
                type: 'line',
                data: {
                    labels: times,
                        datasets: [{ 
                        data: y,
                        pointRadius: 0,  
                        label: "Börvärde",
                        borderColor: "blue",
                        fill: false
                    }, { 
                        data: lindrit_isValue,
                        pointRadius: 2, 
                        label: "Lindrits Ärvärde",
                        borderColor: "red",
                        fill: false
                    },{ 
                        data: linus_isValue,
                        pointRadius: 2, 
                        label: "Linus Ärvärde",
                        borderColor: "green",
                        fill: false
                    },
                    {
                        data: lindrit_error,
                        pointRadius: 2, 
                        label: "Lindrits Error",
                        borderColor: "yellow",
                        fill: false
                    },
                    {
                        data: linus_error,
                        pointRadius: 2, 
                        label: "Linus Error",
                        borderColor: "orange",
                        fill: false
                    }
                    ]
                },
                    options: {
                        animation:{duration: 0},
                    scales: {
                            xAxes: [{
                                    display: true,
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time(S)'
                                    }
                                }],
                            yAxes: [{
                                    display: true,
                                    ticks: {
                                        beginAtZero: true,
                                        steps: 1,
                                        stepValue: 5,
                                        max: 100
                                    }
                                }]
                            },
                title: {
                display: true,
                text: 'Bilarnas är- och börvärden'
                }
                }
                });

                new Chart(document.getElementById("lindritsData"), {
                    type: 'line',
                    data: {
                        labels: times,
                            datasets: [{ 
                            data: linus_PWM,
                            pointRadius: 2, 
                            label: "Linus PWM",
                            borderColor: "green",
                            fill: false
                        },{ 
                            data: lindrit_PWM,
                            pointRadius: 2, 
                            label: "Lindrit PWM",
                            borderColor: "red",
                            fill: false
                        }
                        ]
                    },
                    options: {
                        animation:{duration: 0},
                        scales: {
                                    xAxes: [{
                                            display: true,
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Time(S)'
                                            }
                                        }],
                                    yAxes: [{
                                            display: true,
                                            ticks: {
                                                beginAtZero: true,
                                                steps: 1,
                                                stepValue: 5,
                                                max: 1200
                                            }
                                        }]
                                    },
                        title: {
                        display: true,
                        text: 'Bilarnas PWM'
                    }
                    }
                    });
                    
        }

        function onFail() {
            document.getElementById("messages").style.borderColor = "yellow";

        }  

        function onConnect() {
            console.log(topic);
            client.subscribe(topic);
            document.getElementById("messages").style.borderColor = "green";
        }

        function onSend() {
            let message = document.getElementById("myRange").value;
            console.log(message);
            message= new Paho.MQTT.Message(message);
            message.destinationName=topic;
            client.send(message);
        }

        function updateValue(){
            let message = document.getElementById("myRange").value;
            document.getElementById("demo").innerHTML = message;
        }

        function onConnectionLost(responseObject) {
            document.getElementById("messages").style.borderColor = "yellow";
        }

        function onMessageArrived(message) {
            console.log("onMessageArrived: " + message.payloadString);
            var d = new Date();
            var hours = d.getHours();
            var minutes = d.getMinutes();
            if (minutes < 10){
                var time = hours + ":" + "0" + minutes;
            } else {
                var time = hours + ":" + minutes;
            }
            var mes = message.payloadString;
            var values = mes.split(" ");
            console.log(values)
            number+=1
            let x = document.getElementById("myRange").value
            times.push(number)
            y.push(x)
            if (values[0] == "linus"){
                linus_isValue.push(parseInt(values[1]));
                linus_PWM.push(parseInt(values[2]));
                linus_error.push(parseInt(values[3]));
            } else if (values[0] == "lindrit"){
                lindrit_isValue.push(parseInt(values[1]));
                lindrit_PWM.push(parseInt(values[2]));
                lindrit_error.push(parseInt(values[3]));
            }
            document.getElementById("messages").innerHTML += '<span style="float:left;">' + time + " | " + message.payloadString + '</span><br/>';
            updateGraphs();
            var objDiv = document.getElementById("messages");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        function startDisconnect() {
            client.disconnect();
            document.getElementById("messages").style.borderColor = "red";
            document.getElementById('messages').innerHTML = '';
        }
        </script>
</html>